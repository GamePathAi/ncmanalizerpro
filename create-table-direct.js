// Script para criar tabela email_logs diretamente via SQL no Supabase
// Usa uma abordagem alternativa quando a fun√ß√£o exec n√£o est√° dispon√≠vel

import dotenv from 'dotenv';
import { createClient } from '@supabase/supabase-js';

dotenv.config();

const supabaseUrl = process.env.VITE_SUPABASE_URL;
const serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.VITE_SUPABASE_ANON_KEY;

if (!supabaseUrl || !serviceRoleKey) {
    console.error('‚ùå Vari√°veis de ambiente n√£o encontradas');
    process.exit(1);
}

const supabase = createClient(supabaseUrl, serviceRoleKey);

async function createTableDirect() {
    console.log('üîß Criando tabela email_logs diretamente...');
    
    try {
        // M√©todo 1: Tentar criar via SQL usando rpc personalizada
        console.log('\n1Ô∏è‚É£ Tentando criar tabela via RPC...');
        
        const createTableSQL = `
            CREATE TABLE IF NOT EXISTS email_logs (
                id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                email_id TEXT UNIQUE NOT NULL,
                email TEXT NOT NULL,
                subject TEXT,
                status TEXT NOT NULL DEFAULT 'pending',
                sent_at TIMESTAMPTZ,
                delivered_at TIMESTAMPTZ,
                delayed_at TIMESTAMPTZ,
                complained_at TIMESTAMPTZ,
                bounced_at TIMESTAMPTZ,
                bounce_reason TEXT,
                opened_at TIMESTAMPTZ,
                open_count INTEGER DEFAULT 0,
                clicked_at TIMESTAMPTZ,
                click_count INTEGER DEFAULT 0,
                last_clicked_url TEXT,
                created_at TIMESTAMPTZ DEFAULT NOW(),
                updated_at TIMESTAMPTZ DEFAULT NOW()
            );
            
            -- Criar √≠ndices
            CREATE INDEX IF NOT EXISTS idx_email_logs_email_id ON email_logs(email_id);
            CREATE INDEX IF NOT EXISTS idx_email_logs_email ON email_logs(email);
            CREATE INDEX IF NOT EXISTS idx_email_logs_status ON email_logs(status);
            CREATE INDEX IF NOT EXISTS idx_email_logs_created_at ON email_logs(created_at);
            
            -- Configurar RLS
            ALTER TABLE email_logs ENABLE ROW LEVEL SECURITY;
            
            -- Criar pol√≠ticas
            DROP POLICY IF EXISTS "Allow service role full access" ON email_logs;
            CREATE POLICY "Allow service role full access" ON email_logs
                FOR ALL
                USING (true)
                WITH CHECK (true);
                
            DROP POLICY IF EXISTS "Allow authenticated users read" ON email_logs;
            CREATE POLICY "Allow authenticated users read" ON email_logs
                FOR SELECT
                USING (auth.role() = 'authenticated');
            
            -- Criar fun√ß√£o de timestamp
            CREATE OR REPLACE FUNCTION update_updated_at_column()
            RETURNS TRIGGER AS $$
            BEGIN
                NEW.updated_at = NOW();
                RETURN NEW;
            END;
            $$ language 'plpgsql';
            
            -- Criar trigger
            DROP TRIGGER IF EXISTS update_email_logs_updated_at ON email_logs;
            CREATE TRIGGER update_email_logs_updated_at
                BEFORE UPDATE ON email_logs
                FOR EACH ROW
                EXECUTE FUNCTION update_updated_at_column();
        `;
        
        // Tentar diferentes m√©todos de execu√ß√£o
        const methods = [
            { name: 'exec_sql', params: { sql: createTableSQL } },
            { name: 'execute_sql', params: { query: createTableSQL } },
            { name: 'run_sql', params: { sql: createTableSQL } }
        ];
        
        let success = false;
        
        for (const method of methods) {
            try {
                console.log(`   Tentando m√©todo: ${method.name}`);
                const { data, error } = await supabase.rpc(method.name, method.params);
                
                if (!error) {
                    console.log(`‚úÖ Sucesso com m√©todo: ${method.name}`);
                    success = true;
                    break;
                } else {
                    console.log(`‚ùå Erro com ${method.name}:`, error.message);
                }
            } catch (err) {
                console.log(`‚ùå Exce√ß√£o com ${method.name}:`, err.message);
            }
        }
        
        if (!success) {
            console.log('\n‚ö†Ô∏è Nenhum m√©todo RPC funcionou. Tentando abordagem alternativa...');
            
            // M√©todo 2: Usar fetch direto para a API REST
            console.log('\n2Ô∏è‚É£ Tentando via API REST direta...');
            
            const response = await fetch(`${supabaseUrl}/rest/v1/rpc/exec_sql`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${serviceRoleKey}`,
                    'apikey': serviceRoleKey
                },
                body: JSON.stringify({ sql: createTableSQL })
            });
            
            if (response.ok) {
                console.log('‚úÖ Tabela criada via API REST');
                success = true;
            } else {
                const errorText = await response.text();
                console.log('‚ùå Erro na API REST:', errorText);
            }
        }
        
        if (!success) {
            console.log('\n‚ùå N√£o foi poss√≠vel criar a tabela via API.');
            console.log('\nüìã SOLU√á√ÉO MANUAL:');
            console.log('1. Acesse o dashboard do Supabase: https://supabase.com/dashboard/project/fsntzljufghutoyqxokm');
            console.log('2. V√° em "SQL Editor"');
            console.log('3. Cole e execute o SQL abaixo:');
            console.log('\n--- IN√çCIO DO SQL ---');
            console.log(createTableSQL);
            console.log('--- FIM DO SQL ---\n');
            return false;
        }
        
        // 3. Testar se a tabela foi criada
        console.log('\n3Ô∏è‚É£ Testando se a tabela foi criada...');
        
        const { data: testData, error: testError } = await supabase
            .from('email_logs')
            .select('*')
            .limit(1);
            
        if (testError) {
            console.log('‚ùå Erro ao acessar tabela:', testError.message);
            return false;
        } else {
            console.log('‚úÖ Tabela email_logs acess√≠vel!');
        }
        
        // 4. Inserir registro de teste
        console.log('\n4Ô∏è‚É£ Inserindo registro de teste...');
        
        const testRecord = {
            email_id: `direct-test-${Date.now()}`,
            email: 'teste@exemplo.com',
            subject: 'Teste de cria√ß√£o direta',
            status: 'sent'
        };
        
        const { data: insertData, error: insertError } = await supabase
            .from('email_logs')
            .insert(testRecord)
            .select()
            .single();
            
        if (insertError) {
            console.log('‚ùå Erro ao inserir teste:', insertError.message);
        } else {
            console.log('‚úÖ Registro de teste inserido com sucesso!');
            console.log('üìä Dados:', {
                id: insertData.id,
                email_id: insertData.email_id,
                email: insertData.email,
                status: insertData.status
            });
        }
        
        // 5. Testar Edge Function
        console.log('\n5Ô∏è‚É£ Testando Edge Function com tabela criada...');
        
        const { data: functionData, error: functionError } = await supabase.functions
            .invoke('resend-webhook', {
                body: {
                    type: 'email.sent',
                    data: {
                        email_id: `edge-test-${Date.now()}`,
                        to: ['teste@exemplo.com'],
                        subject: 'Teste Edge Function com tabela',
                        from: 'noreply@exemplo.com'
                    },
                    created_at: new Date().toISOString()
                },
                headers: {
                    'resend-signature': 'whsec_Y87KKZQg2jd1q/pzyf7+nFCw4SSk2Jdo',
                    'resend-timestamp': Date.now().toString()
                }
            });
            
        if (functionError) {
            console.log('‚ùå Erro na Edge Function:', functionError.message);
        } else {
            console.log('‚úÖ Edge Function funcionando!');
            console.log('üìß Resposta:', functionData);
        }
        
        // 6. Verificar registros finais
        console.log('\n6Ô∏è‚É£ Verificando registros na tabela...');
        
        const { data: finalData, error: finalError } = await supabase
            .from('email_logs')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(5);
            
        if (finalError) {
            console.log('‚ùå Erro ao verificar registros:', finalError.message);
        } else {
            console.log('‚úÖ Verifica√ß√£o final conclu√≠da!');
            console.log(`üìä Total de registros: ${finalData.length}`);
            finalData.forEach(record => {
                console.log(`   - ${record.email_id}: ${record.email} (${record.status})`);
            });
        }
        
        console.log('\nüéâ Configura√ß√£o da tabela email_logs conclu√≠da!');
        console.log('\nüìã Pr√≥ximos passos:');
        console.log('1. Configure o webhook no Resend:');
        console.log('   - URL: https://fsntzljufghutoyqxokm.supabase.co/functions/v1/resend-webhook');
        console.log('   - Secret: whsec_Y87KKZQg2jd1q/pzyf7+nFCw4SSk2Jdo');
        console.log('2. Teste enviando um email real');
        console.log('3. Monitore: supabase functions logs resend-webhook');
        
        return true;
        
    } catch (error) {
        console.error('‚ùå Erro geral:', error.message);
        console.log('\nüîß Execute o SQL manualmente no dashboard do Supabase');
        return false;
    }
}

// Executar cria√ß√£o
createTableDirect().then((success) => {
    if (success) {
        console.log('\nüèÅ Cria√ß√£o da tabela finalizada com sucesso!');
        process.exit(0);
    } else {
        console.log('\n‚ùå Falha na cria√ß√£o autom√°tica. Use o m√©todo manual.');
        process.exit(1);
    }
}).catch(err => {
    console.error('‚ùå Erro fatal:', err);
    process.exit(1);
});